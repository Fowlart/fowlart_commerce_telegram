<!DOCTYPE html>
<html>
<title>Public catalog</title>
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="https://www.w3schools.com/w3css/4/w3.css" rel="stylesheet">
<style>
    .w3-button {
        white-space: normal;
        margin: 2px;
        border: solid 1px green;
    }

    .card {
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        max-width: 300px;
        margin: auto;
        text-align: center;
        font-family: arial;
    }

    .card button {
        visibility: visible;
        border: none;
        outline: 0;
        padding: 12px;
        color: white;
        background-color: #000;
        text-align: center;
        cursor: pointer;
        width: 100%;
        font-size: 18px;
    }

    .card button:hover {
        opacity: 0.7;
    }

    .col-25 {
        padding: 0 16px;
    }

    .container_sc_unavailable {
        display: none;
        flex-direction: column;
        justify-content: center;
        background-color: #f2f2f2;
        padding: 5px 20px 15px 20px;
        border: 1px solid lightgrey;
        border-radius: 3px;
    }

    .container_sc {
        height: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background-color: #f2f2f2;
        padding: 5px 20px 15px 20px;
        border: 1px solid lightgrey;
        border-radius: 3px;
    }

    .container_sc input[type=number] {
        margin-left: 10px;
        border: none;
        border-bottom: 2px solid black;
        text-align: center;
        background-color: #f2f2f2;
        width: 70px;
    }

    .container_sc input:invalid {
        border: 4px dashed red;
    }

    .container_sc p {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .submit_card {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .submit_card button {
        border: none;
        height: 40px;
        width: 200px;
        background-color: darkcyan;
        color: white;
    }

    .remove-item-button {
        margin-right: 8px;
        border-radius: 60px;
        border: none;
        text-align: center;
        cursor: pointer;
        width: 20px;
        font-size: 25px;
        background-color: transparent;
    }

    .price {
        color: grey;
        margin-left: 5px;
    }
</style>
<body>

<!-- Sidebar -->
<div class="w3-sidebar w3-bar-block w3-border-right" id="mySidebar" style="display:none">
    <button class="w3-bar-item w3-large" onclick="w3_close()">–∑–∞–∫—Ä–∏—Ç–∏ &times;</button>
    <!--<a href="#" class="w3-bar-item w3-button">Link 1</a>-->
    {{groupLinks}}
</div>

<!-- Page Content -->
<div class="w3-teal">
    <div class="w3-container">
        <h1>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤ </h1>
    </div>
    <button class="w3-button w3-teal w3-xlarge" onclick="w3_open()"> ‚ò∞</button>
</div>
<div class="card">
    <img alt="image" id="itemImage" onchange="onProductNameChange()" src="{{productImageUri}}" style="width:100%">
    <h1 id="nameAndPrice">{{nameAndPrice}}</h1>
    <p>
        <button id="add-to-bucket-button" onclick="addToBucket();">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    </p>
</div>
<div class="col-25" id="bucket">
    <div class="container_sc" id="bucket-container">
        <h4>üõí –ö–æ—Ä–∑–∏–Ω–∞ üõí</h4>
        <div id="bucket-content">
            {{bucketContent}}
        </div>
        <hr>
        <p>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–º–∞ <span class="price"><b id="total"></b></span></p>
        <p class="submit_card" id="submit_card_id">
            <button>–∑–∞–º–æ–≤–∏—Ç–∏</button>
        </p>
    </div>
</div>
<div class="w3-container">
    {{itemList}}
    <!--<button imglink="" class="w3-button w3-block w3-black" >Button</button> -->
</div>

<script>

    document.addEventListener('DOMContentLoaded', async function() {
        let bucketContent = document.getElementById("bucket-content");
        let bucket = document.getElementById("bucket-container");
        if (bucketContent.childElementCount === 0) {
            console.log("bucketContent.innerHTML is empty")
            bucket.className = "container_sc_unavailable";
        } else {
            bucket.className = "container_sc";
            document.getElementById("total").innerHTML = await getBucketSum();
        }
    }, false);

    async function getBucketSum(){
        let myHeaders = new Headers();
        let requestOptions = {
            headers: myHeaders,
            method: 'GET',
            redirect: 'follow'
        };

        return fetch("/pdp/bucket-sum", requestOptions)
            .then(response => response.text())
            .then(result => result + " –≥—Ä–Ω")
            .catch(error => error);
    }

    async function changeQty(itemId,element) {
        document.getElementById("bucket-content").innerHTML = await sendItems(itemId, element.value);
        document.getElementById("total").innerHTML = await getBucketSum();
    }

    async function sendItems(id,qty) {
        let myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/x-www-form-urlencoded");
        let urlencoded = new URLSearchParams();
        urlencoded.append("itemId", id);
        urlencoded.append("itemQuantity", qty);

        let requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: urlencoded,
            redirect: 'follow'
        };


       return fetch("pdp/accept-item", requestOptions)
            .then(response => response.text())
            .then(result => result)
            .catch(error => error);

    }

    async function addToBucket() {
        // remove width and height
        let nameAndPriceAndId = document.getElementById("nameAndPrice").innerHTML;

        if (nameAndPriceAndId.includes("–≥—Ä–Ω")) {

            // extract id from []
            let itemId = nameAndPriceAndId.substring(nameAndPriceAndId.indexOf("[") + 1, nameAndPriceAndId.indexOf("]"));
            let qty = 1;
            let  result = await sendItems(itemId,qty);
            console.log(result);
            // add back bucket
            let bucket = document.getElementById("bucket-container");
            // toggle class
            bucket.className = "container_sc";
            document.getElementById("bucket-content").innerHTML = result;

            let top = document.getElementById("bucket").offsetTop; //Getting Y of target element
            // scroll to that element slowly
            window.scrollTo({
                top: top,
                behavior: 'smooth'
            });

            document.getElementById("total").innerHTML = await getBucketSum();
        } else {
            alert("–í–∏–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä —É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó!");
        }
    }

    async function deleteElement(id) {

        console.log("deleteElement " + id);
        let myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/x-www-form-urlencoded");
        let urlencoded = new URLSearchParams();
        urlencoded.append("itemId", id);

        let requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: urlencoded,
            redirect: 'follow'
        };

        document.getElementById("bucket-content").innerHTML = await fetch("pdp/remove-item", requestOptions)
            .then(response => response.text())
            .then(result => {
                if (result === "") {
                    let bucket = document.getElementById("bucket-container");
                    bucket.className = "container_sc_unavailable";
                }
               return  result;
            })
            .catch(error => error);

        document.getElementById("total").innerHTML = await getBucketSum();
    }

    function changeImage(url, nameAndPrice) {
        document.getElementById("itemImage").src = url;
        document.getElementById("nameAndPrice").innerHTML = nameAndPrice;

        var top = document.getElementById("mySidebar").offsetTop; //Getting Y of target element
        // scroll to that element slowly
        window.scrollTo({
            top: top,
            behavior: 'smooth'
        });
    }

    function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
    }

    function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
    }
</script>

</body>
</html>